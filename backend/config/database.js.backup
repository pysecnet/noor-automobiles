const initSqlJs = require('sql.js');
const fs = require('fs');
const path = require('path');
const bcrypt = require('bcryptjs');

const DB_PATH = path.join(__dirname, '../database.sqlite');

let db = null;

// Initialize database
const initializeDatabase = async () => {
  const SQL = await initSqlJs();
  
  // Always create fresh database for development
  // Remove this condition if you want persistent data
  db = new SQL.Database();
  console.log('New database created');

  // Create tables
  db.run(`
    CREATE TABLE IF NOT EXISTS users (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT NOT NULL,
      email TEXT UNIQUE NOT NULL,
      password TEXT NOT NULL,
      phone TEXT,
      role TEXT DEFAULT 'user' CHECK(role IN ('user', 'admin')),
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `);

  db.run(`
    CREATE TABLE IF NOT EXISTS cars (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      title TEXT NOT NULL,
      brand TEXT NOT NULL,
      model TEXT NOT NULL,
      year INTEGER NOT NULL,
      mileage TEXT,
      engine TEXT,
      transmission TEXT,
      fuel_type TEXT,
      color TEXT,
      body_type TEXT,
      description TEXT,
      features TEXT,
      images TEXT,
      status TEXT DEFAULT 'available' CHECK(status IN ('available', 'sold', 'reserved')),
      featured INTEGER DEFAULT 0,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `);

  db.run(`
    CREATE TABLE IF NOT EXISTS inquiries (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT NOT NULL,
      email TEXT NOT NULL,
      phone TEXT,
      car_id INTEGER,
      message TEXT NOT NULL,
      status TEXT DEFAULT 'pending' CHECK(status IN ('pending', 'contacted', 'closed')),
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (car_id) REFERENCES cars(id) ON DELETE SET NULL
    )
  `);

  // Create admin user - FIXED: Always create on fresh DB
  const hashedPassword = bcrypt.hashSync('admin123', 10);
  try {
    db.run(`
      INSERT INTO users (name, email, password, phone, role) 
      VALUES (?, ?, ?, ?, ?)
    `, ['Muneeb Noor', 'admin@noor.com', hashedPassword, '0324-1344368', 'admin']);
    console.log('✅ Admin user created: admin@noor.com / admin123');
  } catch (e) {
    console.log('Admin user already exists');
  }

  // Insert sample cars
  const sampleCars = [
    {
      title: 'Toyota Supra MK4 Twin Turbo',
      brand: 'Toyota',
      model: 'Supra MK4',
      year: 1998,
      mileage: '45,000 km',
      engine: '2JZ-GTE 3.0L Twin Turbo',
      transmission: '6-Speed Manual',
      fuel_type: 'Petrol',
      color: 'Super White',
      body_type: 'Coupe',
      description: 'Legendary JDM sports car in pristine condition. This iconic Supra features the legendary 2JZ-GTE engine.',
      features: JSON.stringify(['Leather Interior', 'Targa Top', 'Original BBS Wheels', 'Premium Sound System']),
      images: JSON.stringify(['https://images.unsplash.com/photo-1632245889029-e406faaa34cd?w=800&q=80']),
      status: 'available',
      featured: 1
    },
    {
      title: 'Nissan Skyline GT-R R34 V-Spec',
      brand: 'Nissan',
      model: 'Skyline GT-R R34',
      year: 2002,
      mileage: '38,000 km',
      engine: 'RB26DETT 2.6L Twin Turbo',
      transmission: '6-Speed Manual',
      fuel_type: 'Petrol',
      color: 'Bayside Blue',
      body_type: 'Coupe',
      description: 'The crown jewel of JDM culture. This R34 GT-R V-Spec comes in the iconic Bayside Blue.',
      features: JSON.stringify(['ATTESA E-TS Pro AWD', 'Brembo Brakes', 'Recaro Seats']),
      images: JSON.stringify(['https://images.unsplash.com/photo-1629897048514-3dd7414fe72a?w=800&q=80']),
      status: 'available',
      featured: 1
    },
    {
      title: 'Honda NSX Type R',
      brand: 'Honda',
      model: 'NSX Type R',
      year: 2004,
      mileage: '28,000 km',
      engine: 'C32B 3.2L V6 VTEC',
      transmission: '6-Speed Manual',
      fuel_type: 'Petrol',
      color: 'Championship White',
      body_type: 'Coupe',
      description: 'The ultimate expression of Honda engineering excellence.',
      features: JSON.stringify(['Carbon Fiber Hood', 'Recaro Bucket Seats', 'Brembo Brakes']),
      images: JSON.stringify(['https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800&q=80']),
      status: 'available',
      featured: 1
    },
    {
      title: 'Mazda RX-7 FD Spirit R',
      brand: 'Mazda',
      model: 'RX-7 FD',
      year: 2002,
      mileage: '52,000 km',
      engine: '13B-REW Twin Rotor Turbo',
      transmission: '5-Speed Manual',
      fuel_type: 'Petrol',
      color: 'Titanium Gray',
      body_type: 'Coupe',
      description: 'The final and most desirable version of the legendary RX-7.',
      features: JSON.stringify(['Recaro Full Bucket Seats', 'BBS Wheels', 'Bilstein Suspension']),
      images: JSON.stringify(['https://images.unsplash.com/photo-1544636331-e26879cd4d9b?w=800&q=80']),
      status: 'available',
      featured: 1
    },
    {
      title: 'Subaru Impreza WRX STI',
      brand: 'Subaru',
      model: 'Impreza WRX STI',
      year: 2006,
      mileage: '61,000 km',
      engine: 'EJ257 2.5L Turbo Boxer',
      transmission: '6-Speed Manual',
      fuel_type: 'Petrol',
      color: 'World Rally Blue',
      body_type: 'Sedan',
      description: 'Rally-bred performance in its purest form.',
      features: JSON.stringify(['DCCD AWD System', 'Brembo Brakes', 'Recaro Seats']),
      images: JSON.stringify(['https://images.unsplash.com/photo-1580273916550-e323be2ae537?w=800&q=80']),
      status: 'available',
      featured: 1
    },
    {
      title: 'Mitsubishi Lancer Evolution IX',
      brand: 'Mitsubishi',
      model: 'Lancer Evolution IX',
      year: 2006,
      mileage: '48,000 km',
      engine: '4G63T 2.0L Turbo MIVEC',
      transmission: '6-Speed Manual',
      fuel_type: 'Petrol',
      color: 'Graphite Gray',
      body_type: 'Sedan',
      description: 'The pinnacle of the Evolution lineage with MIVEC technology.',
      features: JSON.stringify(['Super-AYC', 'ACD', 'Bilstein Shocks', 'Recaro Seats']),
      images: JSON.stringify(['https://images.unsplash.com/photo-1606664515524-ed2f786a0bd6?w=800&q=80']),
      status: 'reserved',
      featured: 1
    }
  ];

  for (const car of sampleCars) {
    try {
      db.run(`
        INSERT INTO cars (title, brand, model, year, mileage, engine, transmission, fuel_type, color, body_type, description, features, images, status, featured)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `, [car.title, car.brand, car.model, car.year, car.mileage, car.engine, car.transmission, car.fuel_type, car.color, car.body_type, car.description, car.features, car.images, car.status, car.featured]);
    } catch (e) {
      // Ignore duplicate errors
    }
  }
  console.log('✅ Sample cars inserted');

  // Save database to file
  saveDatabase();
  console.log('✅ Database initialized successfully');
  
  return db;
};

// Save database to file
const saveDatabase = () => {
  if (db) {
    const data = db.export();
    const buffer = Buffer.from(data);
    fs.writeFileSync(DB_PATH, buffer);
  }
};

// Helper to run queries and get results as objects
const query = {
  // Get all rows
  all: (sql, params = []) => {
    try {
      const stmt = db.prepare(sql);
      if (params.length > 0) stmt.bind(params);
      
      const results = [];
      while (stmt.step()) {
        const row = stmt.getAsObject();
        results.push(row);
      }
      stmt.free();
      return results;
    } catch (err) {
      console.error('Query error:', err);
      return [];
    }
  },
  
  // Get single row
  get: (sql, params = []) => {
    try {
      const stmt = db.prepare(sql);
      if (params.length > 0) stmt.bind(params);
      
      if (stmt.step()) {
        const row = stmt.getAsObject();
        stmt.free();
        return row;
      }
      stmt.free();
      return null;
    } catch (err) {
      console.error('Query error:', err);
      return null;
    }
  },
  
  // Run insert/update/delete
  run: (sql, params = []) => {
    try {
      db.run(sql, params);
      saveDatabase();
      return {
        lastInsertRowid: db.exec('SELECT last_insert_rowid()')[0]?.values[0]?.[0],
        changes: db.getRowsModified()
      };
    } catch (err) {
      console.error('Query error:', err);
      throw err;
    }
  }
};

// Get the database instance
const getDb = () => db;

module.exports = { initializeDatabase, getDb, query, saveDatabase };
